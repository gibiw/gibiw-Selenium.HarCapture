---
phase: 02-capture-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Selenium.HarCapture/Selenium.HarCapture.csproj
  - src/Selenium.HarCapture/Capture/CaptureType.cs
  - src/Selenium.HarCapture/Capture/CaptureOptions.cs
  - src/Selenium.HarCapture/Capture/Strategies/INetworkCaptureStrategy.cs
  - src/Selenium.HarCapture/Capture/Internal/RequestResponseCorrelator.cs
  - src/Selenium.HarCapture/Capture/Internal/UrlPatternMatcher.cs
autonomous: true
requirements:
  - CAP-02
  - CAP-03
  - CAP-04

must_haves:
  truths:
    - "CaptureType flags can be combined with bitwise OR to control what is captured"
    - "CaptureOptions provides MaxResponseBodySize, URL include/exclude patterns, CaptureTypes, and CreatorName"
    - "UrlPatternMatcher correctly includes/excludes URLs based on glob patterns using DotNet.Glob"
    - "RequestResponseCorrelator thread-safely correlates requests with responses using ConcurrentDictionary+Lazy"
    - "INetworkCaptureStrategy defines the contract for capture backends with lifecycle and event methods"
  artifacts:
    - path: "src/Selenium.HarCapture/Capture/CaptureType.cs"
      provides: "[Flags] enum with bitwise values and convenience combinations"
      contains: "[Flags]"
    - path: "src/Selenium.HarCapture/Capture/CaptureOptions.cs"
      provides: "Configuration class with CaptureTypes, MaxResponseBodySize, URL patterns"
      contains: "CaptureOptions"
    - path: "src/Selenium.HarCapture/Capture/Strategies/INetworkCaptureStrategy.cs"
      provides: "Internal strategy interface with StartAsync/StopAsync/Dispose"
      contains: "internal interface INetworkCaptureStrategy"
    - path: "src/Selenium.HarCapture/Capture/Internal/RequestResponseCorrelator.cs"
      provides: "Thread-safe request/response correlation"
      contains: "ConcurrentDictionary"
    - path: "src/Selenium.HarCapture/Capture/Internal/UrlPatternMatcher.cs"
      provides: "Glob-based URL pattern matching"
      contains: "DotNet.Glob"
  key_links:
    - from: "src/Selenium.HarCapture/Capture/Internal/UrlPatternMatcher.cs"
      to: "DotNet.Glob"
      via: "NuGet package reference"
      pattern: "Glob\\.Parse"
    - from: "src/Selenium.HarCapture/Capture/Internal/RequestResponseCorrelator.cs"
      to: "src/Selenium.HarCapture/Models/HarEntry.cs"
      via: "builds HarEntry from correlated request+response"
      pattern: "new HarEntry"
    - from: "src/Selenium.HarCapture/Capture/Strategies/INetworkCaptureStrategy.cs"
      to: "src/Selenium.HarCapture/Capture/CaptureType.cs"
      via: "StartAsync accepts CaptureType parameter"
      pattern: "CaptureType"
---

<objective>
Create the configuration system, strategy interface, and internal utilities for capture infrastructure.

Purpose: These are the building blocks that the HarCapture orchestrator (Plan 02) and future CDP/INetwork strategies (Phases 3-4) depend on. CaptureType flags control granularity, CaptureOptions configures capture sessions, UrlPatternMatcher filters URLs, RequestResponseCorrelator handles thread-safe event correlation, and INetworkCaptureStrategy defines the strategy contract.

Output: 5 new source files in Capture/ directory tree, DotNet.Glob package added to project.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-capture-infrastructure/02-RESEARCH.md
@src/Selenium.HarCapture/Selenium.HarCapture.csproj
@src/Selenium.HarCapture/Models/HarEntry.cs
@src/Selenium.HarCapture/Models/HarRequest.cs
@src/Selenium.HarCapture/Models/HarResponse.cs
@src/Selenium.HarCapture/Models/HarTimings.cs
@src/Selenium.HarCapture/Models/HarCache.cs
@src/Selenium.HarCapture/Models/HarContent.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: CaptureType enum, CaptureOptions, and INetworkCaptureStrategy interface</name>
  <files>
    src/Selenium.HarCapture/Capture/CaptureType.cs
    src/Selenium.HarCapture/Capture/CaptureOptions.cs
    src/Selenium.HarCapture/Capture/Strategies/INetworkCaptureStrategy.cs
  </files>
  <action>
Create three files in the Capture/ directory:

**CaptureType.cs** — `Selenium.HarCapture.Capture` namespace:
- `[Flags] public enum CaptureType` with values:
  - `None = 0`
  - `RequestHeaders = 1 << 0` (1)
  - `RequestCookies = 1 << 1` (2)
  - `RequestContent = 1 << 2` (4)
  - `RequestBinaryContent = 1 << 3` (8)
  - `ResponseHeaders = 1 << 4` (16)
  - `ResponseCookies = 1 << 5` (32)
  - `ResponseContent = 1 << 6` (64)
  - `ResponseBinaryContent = 1 << 7` (128)
  - `Timings = 1 << 8` (256)
  - `ConnectionInfo = 1 << 9` (512)
  - Convenience combinations: `HeadersAndCookies`, `AllText`, `All`
- XML doc comments on every member

**CaptureOptions.cs** — `Selenium.HarCapture.Capture` namespace:
- `public sealed class CaptureOptions` with mutable properties (get; set;):
  - `CaptureTypes` (CaptureType, default `CaptureType.AllText`)
  - `CreatorName` (string, default "Selenium.HarCapture")
  - `ForceSeleniumNetworkApi` (bool, default false)
  - `MaxResponseBodySize` (long, default 0 meaning unlimited)
  - `UrlIncludePatterns` (IReadOnlyList&lt;string&gt;?, default null meaning include all)
  - `UrlExcludePatterns` (IReadOnlyList&lt;string&gt;?, default null meaning exclude none)
- XML doc comments on every property explaining behavior (especially 0 = unlimited for MaxResponseBodySize, null = no filter for patterns)

**INetworkCaptureStrategy.cs** — `Selenium.HarCapture.Capture.Strategies` namespace:
- `internal interface INetworkCaptureStrategy : IDisposable` with:
  - `string StrategyName { get; }` — human-readable name for diagnostics
  - `bool SupportsDetailedTimings { get; }` — whether strategy provides detailed HAR timings
  - `bool SupportsResponseBody { get; }` — whether strategy can capture response bodies
  - `event Action&lt;HarEntry, string&gt;? EntryCompleted;` — fires when a fully-correlated entry (request+response) is ready. The string parameter is the requestId. Using a single event instead of separate RequestSent/ResponseReceived because correlation is strategy-internal; the orchestrator only cares about complete entries.
  - `Task StartAsync(CaptureOptions options);` — pass full CaptureOptions (not just CaptureType) so strategies can access MaxResponseBodySize and other config
  - `Task StopAsync();`
- XML doc comments on interface and all members
- NOTE: The interface takes CaptureOptions (not just CaptureType) in StartAsync so strategies have access to all configuration including MaxResponseBodySize. This is a deliberate deviation from the research suggestion which passed only CaptureType.
  </action>
  <verify>
Run `dotnet build src/Selenium.HarCapture` — must compile with 0 errors, 0 warnings. Verify CaptureType has [Flags] attribute and bitwise values are correct powers of 2. Verify CaptureOptions defaults are set. Verify INetworkCaptureStrategy is internal.
  </verify>
  <done>
CaptureType enum has 10 individual flags plus 3 convenience combinations. CaptureOptions has 6 properties with documented defaults. INetworkCaptureStrategy is internal with StartAsync/StopAsync/Dispose/EntryCompleted event and 3 diagnostic properties. All compile with 0 warnings.
  </done>
</task>

<task type="auto">
  <name>Task 2: RequestResponseCorrelator and UrlPatternMatcher with DotNet.Glob</name>
  <files>
    src/Selenium.HarCapture/Selenium.HarCapture.csproj
    src/Selenium.HarCapture/Capture/Internal/RequestResponseCorrelator.cs
    src/Selenium.HarCapture/Capture/Internal/UrlPatternMatcher.cs
  </files>
  <action>
First, add DotNet.Glob package:
```
dotnet add src/Selenium.HarCapture package DotNet.Glob --version 3.1.1
```

**RequestResponseCorrelator.cs** — `Selenium.HarCapture.Capture.Internal` namespace:
- `internal sealed class RequestResponseCorrelator`
- Private `ConcurrentDictionary&lt;string, Lazy&lt;PendingEntry&gt;&gt; _pending`
- `public void OnRequestSent(string requestId, HarRequest request, DateTimeOffset startedDateTime)`:
  - Uses `_pending.GetOrAdd(requestId, id => new Lazy&lt;PendingEntry&gt;(() => new PendingEntry(id), LazyThreadSafetyMode.ExecutionAndPublication))`
  - Sets `lazy.Value.Request = request` and `lazy.Value.StartedDateTime = startedDateTime`
- `public HarEntry? OnResponseReceived(string requestId, HarResponse response, HarTimings? timings, double totalTime)`:
  - Uses `_pending.TryRemove(requestId, out var lazy)`
  - If found, sets Response, Time, Timings on PendingEntry, calls `ToHarEntry()` and returns it
  - If not found, returns null (response without matching request)
- `public int PendingCount => _pending.Count;` — for diagnostics
- `public void Clear()` — clears all pending entries (called on Stop)
- Private nested `sealed class PendingEntry` with:
  - `string RequestId { get; }` (constructor param)
  - `HarRequest? Request { get; set; }`
  - `HarResponse? Response { get; set; }`
  - `HarTimings? Timings { get; set; }`
  - `DateTimeOffset StartedDateTime { get; set; }`
  - `double Time { get; set; }`
  - `HarEntry ToHarEntry()` — creates new HarEntry with all fields set. Uses `new HarEntry { StartedDateTime = ..., Time = ..., Request = Request!, Response = Response!, Cache = new HarCache(), Timings = Timings ?? new HarTimings { Send = 0, Wait = 0, Receive = 0 } }`

CRITICAL: HAR model classes are sealed classes with init properties, NOT records. `with` expressions do NOT work on them. Always create NEW instances with object initializer syntax: `new HarEntry { Prop = value }`. Never attempt `entry with { ... }`.

**UrlPatternMatcher.cs** — `Selenium.HarCapture.Capture.Internal` namespace:
- `internal sealed class UrlPatternMatcher`
- Constructor takes `IReadOnlyList&lt;string&gt;? includePatterns, IReadOnlyList&lt;string&gt;? excludePatterns`
- Parse patterns to `DotNet.Glob.Glob[]?` arrays in constructor using `Glob.Parse(pattern)`
- `public bool ShouldCapture(string url)`:
  - If `_excludeGlobs != null` and any match url, return false (exclude takes precedence)
  - If `_includeGlobs != null`, return true only if any match url
  - If no patterns, return true (capture all)
- `public static UrlPatternMatcher CaptureAll` — static property returning instance with no patterns (for default case)
- XML doc comments on class and methods
- Use `using DotNet.Glob;` — the library's main namespace

All `using` statements: `System`, `System.Collections.Concurrent`, `System.Collections.Generic`, `System.Linq`, `DotNet.Glob`, `Selenium.HarCapture.Models` as needed.
  </action>
  <verify>
Run `dotnet build src/Selenium.HarCapture` — must compile with 0 errors, 0 warnings. Run `dotnet test` — all 26 existing tests must still pass (no regressions). Verify DotNet.Glob 3.1.1 appears in csproj.
  </verify>
  <done>
RequestResponseCorrelator uses ConcurrentDictionary with Lazy for thread-safe correlation, produces HarEntry from paired request+response. UrlPatternMatcher uses DotNet.Glob for include/exclude URL filtering with exclude-takes-precedence semantics. DotNet.Glob 3.1.1 added to csproj. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
- `dotnet build src/Selenium.HarCapture` compiles with 0 errors, 0 warnings
- `dotnet test` passes all 26 existing tests (no regressions)
- CaptureType enum has [Flags] and all 13 members (10 individual + 3 combinations)
- CaptureOptions has 6 properties with correct defaults
- INetworkCaptureStrategy is internal, has IDisposable, has EntryCompleted event
- RequestResponseCorrelator uses ConcurrentDictionary&lt;string, Lazy&lt;PendingEntry&gt;&gt;
- UrlPatternMatcher depends on DotNet.Glob, handles include/exclude/no-pattern cases
- File structure: Capture/, Capture/Strategies/, Capture/Internal/ directories created
</verification>

<success_criteria>
6 files created or modified. Build succeeds with 0 warnings. All existing tests pass. Configuration system, strategy interface, and internal utilities are ready for HarCapture orchestrator in Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/02-capture-infrastructure/02-01-SUMMARY.md`
</output>
